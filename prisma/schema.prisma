generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model BookingPlan {
  bookingId                Int             @id @default(autoincrement()) @map("BOOKING_ID")
  ownerGroup               OwnerGroup      @map("OWNER_GROUP")
  meetingRoom              String          @map("MEETING_ROOM") @db.VarChar(50)
  meetingDetail            String?         @map("MEETING_DETAIL") @db.Text
  timeStart                DateTime        @map("TIME_START") @db.DateTime(0)
  timeEnd                  DateTime        @map("TIME_END") @db.DateTime(0)
  bookingStatus            BookingStatus   @default(waiting) @map("BOOKING_STATUS")
  createdAt                DateTime        @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt                DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  drType                   DRType?         @map("DR_TYPE")
  otherType                String?         @map("OTHER_TYPE") @db.VarChar(255)
  otherTypeScope           OtherTypeScope? @map("OTHER_TYPE_SCOPE")
  applicableModel          String?         @map("APPLICABLE_MODEL") @db.VarChar(255)
  interpreterEmpCode       String?         @map("INTERPRETER_EMP_CODE") @db.VarChar(64)
  isRecurring              Boolean         @default(false) @map("IS_RECURRING")
  meetingType              MeetingType     @map("MEETING_TYPE")
  ownerEmpCode             String          @map("OWNER_EMP_CODE") @db.VarChar(64)
  parentBookingId          Int?            @map("PARENT_BOOKING_ID")
  recurrenceEndDate        DateTime?       @map("RECURRENCE_END_DATE") @db.DateTime(0)
  recurrenceEndOccurrences Int?            @map("RECURRENCE_END_OCCURRENCES")
  recurrenceEndType        EndType?        @map("RECURRENCE_END_TYPE")
  recurrenceInterval       Int?            @map("RECURRENCE_INTERVAL")
  recurrenceMonthday       Int?            @map("RECURRENCE_MONTHDAY")
  recurrenceType           RecurrenceType? @map("RECURRENCE_TYPE")
  recurrenceWeekdays       String?         @map("RECURRENCE_WEEKDAYS") @db.VarChar(32)
  recurrenceWeekOrder      WeekOrder?      @map("RECURRENCE_WEEK_ORDER")

  // NEW FIELDS FOR LANGUAGE AND INTERPRETER SELECTION
  languageCode                String?         @map("LANGUAGE_CODE") @db.VarChar(16)
  chairmanEmail               String?         @map("CHAIRMAN_EMAIL") @db.VarChar(255)
  selectedInterpreterEmpCode  String?         @map("SELECTED_INTERPRETER_EMP_CODE") @db.VarChar(64)

  // NEW
  isForwarded        Boolean   @default(false) @map("IS_FORWARDED")
  forwardedByEmpCode String?   @map("FORWARDED_BY_EMP_CODE") @db.VarChar(64)
  forwardActions     Json      @default("[]") @map("FORWARD_ACTIONS")
  //{ empCode, action: 'FORWARD'|'DISMISS'|'APPROVE'|'CANCEL', deptPath, at:, note? }
  forwardedByEmployee Employee?         @relation("ForwardedByEmployee", fields: [forwardedByEmpCode], references: [empCode])
  assignmentLogs      AssignmentLog[]
  interpreterEmployee Employee?         @relation("InterpreterEmployee", fields: [interpreterEmpCode], references: [empCode])
  employee            Employee          @relation("OwnerEmployee", fields: [ownerEmpCode], references: [empCode])
  parentBooking       BookingPlan?      @relation("RecurringBookings", fields: [parentBookingId], references: [bookingId])
  recurringBookings   BookingPlan[]     @relation("RecurringBookings")
  inviteEmails        InviteEmailList[]
  forwardTargets     BookingForwardTarget[]
  
  // NEW RELATIONS
  language                    Language?       @relation(fields: [languageCode], references: [code])
  selectedInterpreter         Employee?       @relation("SelectedInterpreterEmployee", fields: [selectedInterpreterEmpCode], references: [empCode])

  @@index([ownerEmpCode])
  @@index([interpreterEmpCode])
  @@index([parentBookingId])
  @@index([drType])
  @@index([otherTypeScope])
  @@index([forwardedByEmpCode]) // NEW
  @@index([languageCode])
  @@index([chairmanEmail])
  @@index([selectedInterpreterEmpCode])
  @@map("BOOKING_PLAN")
}

// Forward visibility targets per booking, using admin deptPath strings
model BookingForwardTarget {
  bookingId Int      @map("BOOKING_ID")
  deptPath  String   @map("DEPT_PATH") @db.VarChar(512)
  createdAt DateTime @default(now())    @map("created_at") @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  booking BookingPlan @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)

  @@id([bookingId, deptPath])
  @@index([deptPath])
  @@map("BOOKING_FORWARD_TARGET")
}

model Language {
  id        Int      @id @default(autoincrement()) @map("ID")
  code      String   @unique @map("CODE") @db.VarChar(16) // EN, JP, TH
  name      String   @unique @map("NAME") @db.VarChar(128) // English, Japanese, Thai
  isActive  Boolean  @default(true) @map("IS_ACTIVE")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)

  interpreters InterpreterLanguage[]
  bookings     BookingPlan[]

  @@map("LANGUAGE")
}

model InterpreterLanguage {
  id           Int      @id @default(autoincrement()) @map("ID")
  empCode      String   @map("EMP_CODE") @db.VarChar(64)
  languageCode String   @map("LANGUAGE_CODE") @db.VarChar(16)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  employee     Employee @relation(fields: [empCode], references: [empCode])
  language     Language @relation(fields: [languageCode], references: [code])

  @@unique([empCode, languageCode], name: "unique_emp_language")
  @@index([empCode])
  @@index([languageCode])
  @@map("INTERPRETER_LANGUAGE")
}

model AdminVision {
  id           Int      @id @default(autoincrement()) @map("ID")
  adminEmpCode String   @map("ADMIN_EMP_CODE") @db.VarChar(64)
  deptPath     String   @map("DEPT_PATH") @db.VarChar(512)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  admin        Employee @relation(fields: [adminEmpCode], references: [empCode])

  @@unique([adminEmpCode, deptPath], name: "unique_admin_dept")
  @@index([adminEmpCode])
  @@map("ADMIN_VISION")
}

model InviteEmailList {
  emailListId Int         @id @default(autoincrement()) @map("EMAIL_LIST_ID")
  bookingId   Int         @map("BOOKING_ID")
  email       String      @map("EMAIL") @db.VarChar(255)
  invitedAt   DateTime    @default(now()) @map("invited_at") @db.Timestamp(0)
  bookingPlan BookingPlan @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)

  @@unique([bookingId, email], name: "unique_booking_email")
  @@map("INVITE_EMAIL_LIST")
}

model Employee {
  id                    Int                   @id @default(autoincrement()) @map("ID")
  empCode               String                @unique @map("EMP_CODE") @db.VarChar(64)
  prefixEn              String?               @map("PREFIX_EN") @db.VarChar(32)
  firstNameEn           String?               @map("FIRST_NAME_EN") @db.VarChar(255)
  lastNameEn            String?               @map("LAST_NAME_EN") @db.VarChar(255)
  prefixTh              String?               @map("PREFIX_TH") @db.VarChar(32)
  firstNameTh           String?               @map("FIRST_NAME_TH") @db.VarChar(255)
  lastNameTh            String?               @map("LAST_NAME_TH") @db.VarChar(255)
  fno                   String?               @map("FNO") @db.VarChar(64)
  deptPath              String?               @map("DEPT_PATH") @db.VarChar(512)
  positionTitle         String?               @map("POSITION_TITLE") @db.VarChar(255)
  email                 String?               @map("EMAIL") @db.VarChar(255)
  telExt                String?               @map("TEL_EXT") @db.VarChar(64)
  isActive              Boolean               @default(true) @map("IS_ACTIVE")
  lastLoginAt           DateTime?             @map("LAST_LOGIN_AT")
  syncedAt              DateTime?             @map("SYNCED_AT")
  createdAt             DateTime              @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt             DateTime              @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  assignmentLogs        AssignmentLog[]       @relation("AssignmentLogInterpreter")
  bookingsAsInterpreter BookingPlan[]         @relation("InterpreterEmployee")
  bookingsOwned         BookingPlan[]         @relation("OwnerEmployee")
  bookingsForwarded     BookingPlan[]         @relation("ForwardedByEmployee")
  bookingsSelectedAsInterpreter BookingPlan[] @relation("SelectedInterpreterEmployee")
  userRoles             UserRole[]
  interpreterLanguages  InterpreterLanguage[]
  adminVisions          AdminVision[]
  environmentAdminLinks        EnvironmentAdmin[]       @relation("EmployeeEnvironmentAdmin")
  environmentInterpreterLinks  EnvironmentInterpreter[] @relation("EmployeeEnvironmentInterpreter")

  @@map("EMPLOYEE")
}

model UserRole {
  userId   Int      @map("USER_ID")
  roleCode RoleCode @map("ROLE_CODE")
  employee Employee @relation(fields: [userId], references: [id])

  @@id([userId, roleCode])
  @@map("USER_ROLE")
}

model AutoAssignmentConfig {
  id                   Int      @id @default(autoincrement()) @map("ID")
  autoAssignEnabled    Boolean  @default(true) @map("AUTO_ASSIGN_ENABLED")
  mode                 String   @default("NORMAL") @map("MODE")
  fairnessWindowDays   Int      @default(30) @map("FAIRNESS_WINDOW_DAYS")
  maxGapHours          Int      @default(10) @map("MAX_GAP_HOURS")
  MIN_ADVANCE_DAYS     Int      @default(2)
  w_fair               Float    @default(1.2) @map("W_FAIR")
  w_urgency            Float    @default(0.5) @map("W_URGENCY")
  w_lrs                Float    @default(0.3) @map("W_LRS")
  drConsecutivePenalty Float    @default(-0.7) @map("DR_CONSECUTIVE_PENALTY")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamp(0)

  @@map("AUTO_ASSIGNMENT_CONFIG")
}

model MeetingTypePriority {
  id                   Int         @id @default(autoincrement()) @map("ID")
  meetingType          MeetingType @unique @map("MEETING_TYPE")
  priorityValue        Int         @map("PRIORITY_VALUE")
  urgentThresholdDays  Int         @map("URGENT_THRESHOLD_DAYS")
  generalThresholdDays Int         @map("GENERAL_THRESHOLD_DAYS")
  createdAt            DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt            DateTime    @updatedAt @map("updated_at") @db.Timestamp(0)

  // Optional link to Environment for future per-environment override (defaults remain global)
  environmentId        Int?        @map("ENVIRONMENT_ID")
  environment          Environment? @relation(fields: [environmentId], references: [id])

  @@map("MEETING_TYPE_PRIORITY")
}

model MeetingTypeModeThreshold {
  id                   Int         @id @default(autoincrement()) @map("ID")
  meetingType          MeetingType @map("MEETING_TYPE")
  assignmentMode       String      @map("ASSIGNMENT_MODE") @db.VarChar(20)
  urgentThresholdDays  Int         @map("URGENT_THRESHOLD_DAYS")
  generalThresholdDays Int         @map("GENERAL_THRESHOLD_DAYS")
  createdAt            DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt            DateTime    @updatedAt @map("updated_at") @db.Timestamp(0)

  @@unique([meetingType, assignmentMode])
  @@map("MEETING_TYPE_MODE_THRESHOLD")
}

model AssignmentLog {
  id                  Int         @id @default(autoincrement()) @map("ID")
  bookingId           Int         @map("BOOKING_ID")
  interpreterEmpCode  String?     @map("INTERPRETER_EMP_CODE") @db.VarChar(64)
  status              String      @map("STATUS") @db.VarChar(32)
  reason              String?     @map("REASON") @db.Text
  preHoursSnapshot    Json        @map("PRE_HOURS_SNAPSHOT")
  postHoursSnapshot   Json?       @map("POST_HOURS_SNAPSHOT")
  scoreBreakdown      Json?       @map("SCORE_BREAKDOWN")
  maxGapHours         Int         @map("MAX_GAP_HOURS")
  fairnessWindowDays  Int         @map("FAIRNESS_WINDOW_DAYS")
  conflictDetection   Json?       @map("CONFLICT_DETECTION")
  drPolicyDecision    Json?       @map("DR_POLICY_DECISION")
  performance         Json?       @map("PERFORMANCE")
  systemState         Json?       @map("SYSTEM_STATE")
  createdAt           DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  bookingPlan         BookingPlan @relation(fields: [bookingId], references: [bookingId], onDelete: Cascade)
  interpreterEmployee Employee?   @relation("AssignmentLogInterpreter", fields: [interpreterEmpCode], references: [empCode])

  @@index([bookingId])
  @@index([interpreterEmpCode])
  @@index([status])
  @@map("ASSIGNMENT_LOG")
}

model ConflictDetectionLog {
  id                       Int      @id @default(autoincrement()) @map("ID")
  timestamp                DateTime @map("TIMESTAMP") @db.DateTime(0)
  bookingId                Int      @map("BOOKING_ID")
  requestedTimeStart       DateTime @map("REQUESTED_TIME_START") @db.DateTime(0)
  requestedTimeEnd         DateTime @map("REQUESTED_TIME_END") @db.DateTime(0)
  totalInterpretersChecked Int      @map("TOTAL_INTERPRETERS_CHECKED")
  availableInterpreters    Int      @map("AVAILABLE_INTERPRETERS")
  conflictedInterpreters   Int      @map("CONFLICTED_INTERPRETERS")
  conflicts                Json     @map("CONFLICTS")
  processingTimeMs         Int      @map("PROCESSING_TIME_MS")
  resolutionStrategy       String   @map("RESOLUTION_STRATEGY") @db.VarChar(64)
  outcome                  String   @map("OUTCOME") @db.VarChar(32)
  createdAt                DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([bookingId])
  @@index([timestamp])
  @@index([outcome])
  @@map("CONFLICT_DETECTION_LOG")
}

model DRPolicyLog {
  id                      Int      @id @default(autoincrement()) @map("ID")
  timestamp               DateTime @map("TIMESTAMP") @db.DateTime(0)
  bookingId               Int      @map("BOOKING_ID")
  interpreterId           String   @map("INTERPRETER_ID") @db.VarChar(64)
  isDRMeeting             Boolean  @map("IS_DR_MEETING")
  drType                  String?  @map("DR_TYPE") @db.VarChar(64)
  mode                    String   @map("MODE") @db.VarChar(32)
  policyApplied           Json     @map("POLICY_APPLIED")
  lastGlobalDR            Json?    @map("LAST_GLOBAL_DR")
  drHistory               Json     @map("DR_HISTORY")
  alternativeInterpreters Int      @map("ALTERNATIVE_INTERPRETERS")
  finalDecision           String   @map("FINAL_DECISION") @db.VarChar(32)
  decisionRationale       String   @map("DECISION_RATIONALE") @db.Text
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([bookingId])
  @@index([interpreterId])
  @@index([timestamp])
  @@index([finalDecision])
  @@map("DR_POLICY_LOG")
}

model SystemErrorLog {
  id           Int      @id @default(autoincrement()) @map("ID")
  timestamp    DateTime @map("TIMESTAMP") @db.DateTime(0)
  operation    String   @map("OPERATION") @db.VarChar(128)
  bookingId    Int?     @map("BOOKING_ID")
  errorName    String   @map("ERROR_NAME") @db.VarChar(128)
  errorMessage String   @map("ERROR_MESSAGE") @db.Text
  errorStack   String?  @map("ERROR_STACK") @db.Text
  context      Json?    @map("CONTEXT")
  systemState  Json?    @map("SYSTEM_STATE")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  @@index([timestamp])
  @@index([operation])
  @@index([bookingId])
  @@index([errorName])
  @@map("SYSTEM_ERROR_LOG")
}

enum DRType {
  DR_PR @map("DR-PR")
  DR_k  @map("DR-k")
  DR_II @map("DR-II")
  DR_I  @map("DR-I")
  Other @map("Other")

  @@map("dr_type")
}

enum OtherTypeScope {
  meeting_type
  dr_type

  @@map("other_type_scope")
}

enum OwnerGroup {
  iot
  hardware
  software
  other

  @@map("owner_group")
}

enum MeetingType {
  DR
  VIP
  Weekly
  General
  Urgent
  President
  Other
}

enum BookingStatus {
  approve
  cancel
  waiting
  complet

  @@map("booking_status")
}

enum RecurrenceType {
  daily
  weekly
  biweekly
  monthly
  custom
}

enum EndType {
  never
  on_date
  after_occurrences
}

enum WeekOrder {
  first
  second
  third
  fourth
  last
}

enum RoleCode {
  ADMIN
  INTERPRETER
  SUPER_ADMIN
}

// ================== Environment Models ==================

model Environment {
  id           Int        @id @default(autoincrement()) @map("ID")
  name         String     @map("NAME") @db.VarChar(128)
  isActive     Boolean    @default(true) @map("IS_ACTIVE")
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt    DateTime   @updatedAt @map("updated_at") @db.Timestamp(0)

  centers      EnvironmentCenter[]
  admins       EnvironmentAdmin[]
  interpreters EnvironmentInterpreter[]
  priorities   MeetingTypePriority[]

  @@unique([name])
  @@map("ENVIRONMENT")
}

// Center = normalized middle segment (e.g., bbb from aaa/bbb/ccc)
model EnvironmentCenter {
  id            Int          @id @default(autoincrement()) @map("ID")
  environmentId Int          @map("ENVIRONMENT_ID")
  center        String       @map("CENTER") @db.VarChar(128)
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamp(0)
  environment   Environment  @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([center])
  @@index([environmentId])
  @@map("ENVIRONMENT_CENTER")
}

// Admins who manage an environment
model EnvironmentAdmin {
  id            Int         @id @default(autoincrement()) @map("ID")
  environmentId Int         @map("ENVIRONMENT_ID")
  adminEmpCode  String      @map("ADMIN_EMP_CODE") @db.VarChar(64)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  admin         Employee    @relation("EmployeeEnvironmentAdmin", fields: [adminEmpCode], references: [empCode])

  @@unique([environmentId, adminEmpCode], name: "unique_env_admin")
  @@index([adminEmpCode])
  @@map("ENVIRONMENT_ADMIN")
}

// Interpreters belonging to an environment
model EnvironmentInterpreter {
  id                  Int         @id @default(autoincrement()) @map("ID")
  environmentId       Int         @map("ENVIRONMENT_ID")
  interpreterEmpCode  String      @map("INTERPRETER_EMP_CODE") @db.VarChar(64)
  createdAt           DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  environment         Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  interpreter         Employee    @relation("EmployeeEnvironmentInterpreter", fields: [interpreterEmpCode], references: [empCode])

  @@unique([environmentId, interpreterEmpCode], name: "unique_env_interpreter")
  @@index([interpreterEmpCode])
  @@map("ENVIRONMENT_INTERPRETER")
}
